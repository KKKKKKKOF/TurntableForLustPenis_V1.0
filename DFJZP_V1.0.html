<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>请选择今天打飞机次数</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#0b1020; --bg2:#111a3a;
    --glass:#ffffff28; --stroke:#ffffff30; --text:#eaf2ff;
    --accent:#7cf2ff; --btn:#6b8cff; --btn2:#9b6bff; --glow:#6b8cff;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:"Outfit",system-ui,-apple-system,Segoe UI,Arial;
    color:var(--text); background: radial-gradient(1200px 800px at 70% 20%, #1d2b6f55 0%, transparent 60%),
                         radial-gradient(900px 900px at 20% 80%, #ff59a855 0%, transparent 65%),
                         linear-gradient(160deg,var(--bg1),var(--bg2));
    background-attachment: fixed;
  }
  .grain:before{
    content:""; position:fixed; inset:0; pointer-events:none; opacity:.06;
    background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.75' numOctaves='2'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='.45'/%3E%3C/svg%3E");
    mix-blend-mode:overlay;
  }
  .wrap{max-width:1100px; margin:32px auto; padding:24px; position:relative}
  .header{
    display:flex; align-items:center; justify-content:space-between; gap:16px; flex-wrap:wrap;
    margin-bottom:16px;
  }
  .title{
    font-weight:800; letter-spacing:.3px; font-size:28px;
    text-shadow:0 0 24px #7cf2ff40, 0 0 48px #ff59a840;
  }
  .panel{
    background:linear-gradient(180deg, #ffffff10, #ffffff06);
    border:1px solid var(--stroke); border-radius:16px; backdrop-filter: blur(10px);
    box-shadow: 0 10px 40px #00000060, 0 0 80px #7cf2ff25 inset;
  }
  .grid{
    display:grid; grid-template-columns: 1.1fr .9fr; gap:20px;
  }
  @media (max-width: 900px){
    .grid{grid-template-columns:1fr}
  }
  .stage{padding:20px; position:relative}
  .legend{padding:14px 16px; display:flex; flex-direction:column; gap:10px}
  .legend h3{margin:0 0 4px 0; font-size:16px; opacity:.9}
  .legend-item{
    display:flex; align-items:center; justify-content:space-between; gap:8px;
    padding:8px 10px; border:1px solid var(--stroke); border-radius:10px;
    background: #ffffff0a;
  }
  .legend {
  display: none !important;
  }
  .grid {
  display: block;
  }
  .tag{display:flex; align-items:center; gap:10px}
  .swatch{width:14px; height:14px; border-radius:3px; box-shadow:0 0 12px #ffffff60 inset, 0 0 12px currentColor}
  .name{font-weight:600}
  .prob{opacity:.9}
  .controls{display:flex; align-items:center; gap:10px; padding:14px 16px; border-top:1px dashed var(--stroke)}
  button.spin{
    appearance:none; border:none; color:white; cursor:pointer;
    padding:12px 18px; border-radius:12px; font-weight:700; letter-spacing:.3px;
    background: linear-gradient(135deg, var(--btn), var(--btn2));
    box-shadow: 0 10px 30px #6b8cff60, 0 0 0 0 #6b8cff00, inset 0 0 18px #ffffff25;
    transition: transform .08s ease, box-shadow .4s ease, filter .2s ease;
  }
  button.spin:hover{transform: translateY(-1px); filter:saturate(1.1); box-shadow: 0 14px 38px #6b8cff80, 0 0 22px #9b6bff60 inset}
  button.spin:disabled{opacity:.6; filter:grayscale(.2); cursor:not-allowed; transform:none; box-shadow:none}
  .status{font-size:14px; opacity:.9}
  .result{
    margin-top:16px; padding:12px 16px; border-top:1px dashed var(--stroke);
    font-size:14px; line-height:1.4;
  }
  /* Wheel container */
  .wheel-box{
    position:relative; aspect-ratio:1/1; max-width:560px; margin:0 auto;
    filter: drop-shadow(0 18px 60px #00000080) saturate(1.06);
  }
  svg{display:block; width:100%; height:auto}
  .ring{filter: drop-shadow(0 0 26px #7cf2ff55)}
  .center-cap{
    fill:#0b1129; stroke:#7cf2ff; stroke-width:2;
    filter: drop-shadow(0 0 10px #7cf2ff80);
  }
  .pointer{
    position:absolute; left:50%; top:-6px; transform:translateX(-50%);
    width:0; height:0; border-left:12px solid transparent; border-right:12px solid transparent;
    border-bottom:20px solid #7cf2ff; filter: drop-shadow(0 0 8px #7cf2ff);
  }
  .pointer-shine{
    position:absolute; left:50%; top:18px; transform:translateX(-50%); width:4px; height:14px; border-radius:2px;
    background:linear-gradient(180deg,#fff,#7cf2ff00); opacity:.7; filter:blur(.3px)
  }
  .tick{stroke:#ffffff30; stroke-width:1}
  .slice-border{stroke:#00000030; stroke-width:.8}
  .label text{
    font-size:13px; font-weight:600; fill:#f7fbff; paint-order: stroke; stroke:#0006; stroke-width:.8px;
    text-anchor:middle; dominant-baseline:middle;
  }
  @media (max-width:480px){
    .label text{font-size:12px}
  }
  .foot{margin-top:18px; font-size:12px; opacity:.8; display:flex; gap:12px; flex-wrap:wrap; padding:0 6px}
  .kbd{
    padding:2px 6px; border-radius:6px; background:#ffffff14; border:1px solid #ffffff2a; font-weight:600
  }
</style>
</head>
<body class="grain">
  <div class="wrap">
    <div class="header">
      <div class="title">每日一次｜打飞机转盘</div>
    </div>

    <div class="grid">
      <div class="panel stage">
        <div class="wheel-box" id="wheelBox">
          <div class="pointer"></div><div class="pointer-shine"></div>
          <svg id="wheelSVG" viewBox="0 0 600 600" aria-label="决策转盘">
            <defs>
              <filter id="innerGlow" x="-50%" y="-50%" width="200%" height="200%">
                <feGaussianBlur in="SourceGraphic" stdDeviation="6" result="blur"/>
                <feMerge>
                  <feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/>
                </feMerge>
              </filter>
            </defs>
            <!-- static rings -->
            <circle cx="300" cy="300" r="284" fill="#ffffff08" stroke="#7cf2ff30" stroke-width="2" class="ring"/>
            <g id="wheel" transform="rotate(0,300,300)"></g>
            <circle class="center-cap" cx="300" cy="300" r="38"/>
          </svg>
        </div>
        <div class="result" id="resultBox"></div>
      </div>

      <div class="panel">
        <div class="legend">
          <h3>彩色图例与概率</h3>
          <div id="legendList"></div>
        </div>
        
        <div class="controls">
          <button class="spin" id="spinBtn">开始抽签</button>
          <div class="status" id="statusText">每天仅可旋转一次</div>
        </div>
      </div>
    </div>



<script>
(function(){
  // 配置：选项与概率（权重，合计 100）
  const OPTIONS = [
    { name:"不打", weight:1 },
    { name:"现在打", weight:15 },
    { name:"一直打不停", weight:4 },
    { name:"早上打一次", weight:10 },
    { name:"中午打一次", weight:10 },
    { name:"晚上打一次", weight:10 },
    { name:"睡前打一次", weight:10 },
    { name:"早中晚各一次", weight:10 },
    { name:"今天内打一次", weight:10 },
    { name:"今天内打两次", weight:10 },
    { name:"今天内打三次", weight:10 },
  ];
  // 多巴胺色板（可自行替换/增删）
  const COLORS = [
    "#FF6B6B","#FFD93D","#6BCB77","#4D96FF","#B084F6",
    "#FF8E9E","#00C2FF","#FF5E00","#00FFC6","#F9F871","#FF9F1C"
  ];

  const $wheel = document.getElementById("wheel");
  const $svg = document.getElementById("wheelSVG");
  const $spin = document.getElementById("spinBtn");
  const $status = document.getElementById("statusText");
  const $result = document.getElementById("resultBox");
  const $legend = document.getElementById("legendList");

  const CX=300, CY=300, R=270, R_INNER=70, LABEL_R = 175;

  // 日界（本地时间）格式：YYYY-MM-DD
  function localDateKey(d=new Date()){
    const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), day=String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }
  const STORAGE_KEY = "dopamine-wheel-v1";
  const todayKey = localDateKey();

  // 生成加密随机 [0,1)
  function cryptoRandom(){
    const buf = new Uint32Array(1);
    crypto.getRandomValues(buf);
    // 除以 2^32，范围 [0,1)
    return buf[0] / 4294967296;
  }

  // 预处理角度
  const total = OPTIONS.reduce((s,o)=>s+o.weight,0);
  let acc=0;
  const slices = OPTIONS.map((o,i)=>{
    const start = acc/total * 360 - 90; // 以 12 点为 -90°
    const end = (acc+o.weight)/total * 360 - 90;
    const mid = (start+end)/2;
    acc += o.weight;
    return {
      ...o, index:i, color: COLORS[i % COLORS.length],
      start, end, mid
    };
  });

  // 绘制扇区路径
  function polar(cx,cy,r,deg){
    const rad = deg * Math.PI/180;
    return { x: cx + r * Math.cos(rad), y: cy + r * Math.sin(rad) };
  }
  function arcPath(cx,cy,r,start,end){
    const p1 = polar(cx,cy,r,start);
    const p2 = polar(cx,cy,r,end);
    const large = (end - start + 360) % 360 > 180 ? 1 : 0;
    return `M ${cx} ${cy} L ${p1.x} ${p1.y} A ${r} ${r} 0 ${large} 1 ${p2.x} ${p2.y} Z`;
  }

  // 渲染图例
  function renderLegend(){
    $legend.innerHTML = "";
    slices.forEach(s=>{
      const row = document.createElement("div");
      row.className="legend-item";
      row.innerHTML = `
        <div class="tag">
          <div class="swatch" style="background:${s.color};"></div>
          <div class="name">${s.name}</div>
        </div>
        <div class="prob">${s.weight}%</div>
      `;
      $legend.appendChild(row);
    });
  }

  // 绘制转盘（扇区 + 标签）
  function renderWheel(){
    $wheel.innerHTML="";
    // 扇区
    slices.forEach(s=>{
      const g = document.createElementNS("http://www.w3.org/2000/svg","g");
      // slice
      const path = document.createElementNS("http://www.w3.org/2000/svg","path");
      path.setAttribute("d", arcPath(CX,CY,R, s.start, s.end));
      path.setAttribute("fill", s.color);
      path.setAttribute("class","slice");
      path.setAttribute("opacity","0.96");
      path.setAttribute("filter","url(#innerGlow)");
      path.setAttribute("stroke","rgba(0,0,0,0.25)");
      path.setAttribute("stroke-width",".8");
      g.appendChild(path);
      // 内圈边
      const inner = document.createElementNS("http://www.w3.org/2000/svg","circle");
      inner.setAttribute("cx",CX); inner.setAttribute("cy",CY);
      inner.setAttribute("r",R_INNER); inner.setAttribute("fill","#00000025");
      inner.setAttribute("stroke","#ffffff15"); inner.setAttribute("stroke-width","1");
      // 标签
      const labelG = document.createElementNS("http://www.w3.org/2000/svg","g");
      labelG.setAttribute("class","label");
      // 外层：把锚点旋到扇区中心，再沿半径移动
      const outer = document.createElementNS("http://www.w3.org/2000/svg","g");
      outer.setAttribute("transform", `rotate(${s.mid},${CX},${CY}) translate(${LABEL_R},0)`);
      // 内层：先抵消扇区旋转，使文字水平；再在动画里抵消“整盘旋转”
      const upright = document.createElementNS("http://www.w3.org/2000/svg","g");
      upright.setAttribute("class","upright");
      upright.dataset.base = (-s.mid).toString(); // 初始抵消角
      upright.setAttribute("transform", `rotate(${-s.mid},${CX},${CY})`);
      const text = document.createElementNS("http://www.w3.org/2000/svg","text");
      text.setAttribute("x", CX); text.setAttribute("y", CY);
      text.textContent = s.name; // 也可写 `${s.name}（${s.weight}%）`
      upright.appendChild(text);
      outer.appendChild(upright);
      labelG.appendChild(outer);
      $wheel.appendChild(g);
      $wheel.appendChild(labelG);
    });

    // 刻度（可选）
    const ticks = document.createElementNS("http://www.w3.org/2000/svg","g");
    slices.forEach(s=>{
      const p1 = polar(CX,CY,R, s.start), p2 = polar(CX,CY,R_INNER, s.start);
      const line = document.createElementNS("http://www.w3.org/2000/svg","line");
      line.setAttribute("x1",p1.x); line.setAttribute("y1",p1.y);
      line.setAttribute("x2",p2.x); line.setAttribute("y2",p2.y);
      line.setAttribute("class","tick");
      ticks.appendChild(line);
    });
    $wheel.appendChild(ticks);
  }

  // 逐帧更新文字水平补偿
  function setRotation(deg){
    $wheel.setAttribute("transform", `rotate(${deg},${CX},${CY})`);
    const uprights = $wheel.querySelectorAll(".upright");
    uprights.forEach(u=>{
      const base = parseFloat(u.dataset.base || "0");
      // base 已抵消扇区角，再抵消整体旋转
      u.setAttribute("transform", `rotate(${base - deg},${CX},${CY})`);
    });
  }

  // 权重抽样
  function drawIndex(u){
    let cum=0;
    for(let i=0;i<slices.length;i++){
      cum += slices[i].weight / total;
      if(u < cum) return i;
    }
    return slices.length-1; // 兜底
  }

  // 读取/写入存储
  function readStore(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : {};
    }catch(e){ return {}; }
  }
  function writeStore(obj){ localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); }

  // 展示结果卡
  function renderResultCard(rec){
    if(!rec){ $result.innerHTML=""; return; }
    const s = slices[rec.index];
    const dt = new Date(rec.time);
    const tstr = dt.toLocaleString();
    $result.innerHTML = `
      <div><strong>今日结果：</strong><span style="color:${s.color}; font-weight:700">${s.name}</span></div>
      <div style="margin-top:6px; opacity:.9">
        <strong>时间：</strong>${tstr}　
      </div>
    `;
  }

  // 动画
  let isSpinning=false, currentRot=0;
  async function spinOnce(){
    if(isSpinning) return;
    // 每日限制
    const store = readStore();
    if(store[todayKey]){
      $status.textContent = "今天已抽签：结果已在下方记录";
      renderResultCard(store[todayKey]);
      $spin.disabled = true;
      return;
    }
    isSpinning = true;
    $spin.disabled = true;
    $status.textContent = "旋转中…";

    // 抽样
    const u = cryptoRandom();
    const idx = drawIndex(u);
    const choice = slices[idx];

    // 计算停在指针上的旋转角：目标让 choice.mid 旋到 12 点（-90°）
    const baseTarget = -90 - choice.mid;
    // 增加整圈数与微扰，获得视觉随机性但不改变落点
    const extraTurns = 4 + Math.floor(cryptoRandom()*3); // 4~6 圈
    const target = baseTarget + extraTurns * 360;

    // 动画参数
    const start = currentRot;
    const end = target;
    const dur = 4200 + Math.floor(cryptoRandom()*800); // 4.2~5s
    const t0 = performance.now();

    return new Promise(resolve=>{
      const tick = (now)=>{
        const t = Math.min(1, (now - t0) / dur);
        // ease-out-cubic
        const ease = 1 - Math.pow(1 - t, 3);
        const rot = start + (end - start) * ease;
        setRotation(rot);
        if(t < 1){
          requestAnimationFrame(tick);
        }else{
          currentRot = end % 360;
          // 记录结果
          const rec = {
            date: todayKey, time: Date.now(),
            u, index: idx, target: end
          };
          const s = readStore();
          s[todayKey] = rec; writeStore(s);
          renderResultCard(rec);
          $status.textContent = "今天的抽签已完成";
          resolve();
        }
      };
      requestAnimationFrame(tick);
    }).finally(()=>{
      isSpinning=false;
      // 按要求：当天内保持禁用
      $spin.disabled = true;
    });
  }

  // 初始化
  renderLegend();
  renderWheel();
  setRotation(0);

  // 恢复状态
  const s0 = readStore();
  if(s0[todayKey]){
    $status.textContent = "今天已抽签：结果如下";
    renderResultCard(s0[todayKey]);
    $spin.disabled = true;
  }else{
    $status.textContent = "每天仅可旋转一次";
  }

  $spin.addEventListener("click", spinOnce);

  // 跨日刷新提示（保持简单：用户刷新页面后生效）
  let lastKey = todayKey;
  setInterval(()=>{
    const nowKey = localDateKey();
    if(nowKey !== lastKey){
      // 新的一天，允许抽签（需要用户刷新页面以重绘）
      $status.textContent = "已到新的一天，刷新页面即可抽签";
      lastKey = nowKey;
    }
  }, 60000);

})();
</script>
</body>
</html>
